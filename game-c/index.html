<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文学诗词大挑战 - 文学互动小游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 自定义开关样式 */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        .toggle-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.2);
        }
        
        /* 填空样式 */
        .blank-space {
            display: inline-block;
            min-width: 60px;
            border-bottom: 2px solid #4F46E5;
            margin: 0 4px;
            text-align: center;
            cursor: pointer;
            color: #4F46E5;
            font-weight: bold;
        }
        
        .blank-space.filled {
            border-bottom: 2px solid #10B981;
            color: #10B981;
        }
        
        .blank-space.empty {
            color: #6B7280;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
    <!-- 加载层 -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div id="overlay-content"></div>
        </div>
    </div>

    <!-- 主容器 -->
    <div id="app" class="max-w-md mx-auto p-5 bg-white rounded-lg shadow-md shadow-md mt-5 min-h-screen">
        <!-- 顶部导航 -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">诗词大挑战</h1>
            <div class="flex items-center gap-3">
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center">
                    <i class="fa fa-star mr-1"></i>
                    <span id="score-display">0</span>
                </span>
                <button id="rules-btn" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                    <i class="fa fa-question-circle"></i>
                </button>
            </div>
        </header>

        <!-- 游戏状态 -->
        <div class="flex justify-between items-center mb-6">
            <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm flex items-center">
                <i class="fa fa-refresh mr-1"></i>
                <span>答题次数: </span>
                <span id="attempts-display">0</span>
            </div>
            <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm flex items-center">
                <i class="fa fa-trophy mr-1"></i>
                <span id="rank-display">--</span>
            </div>
        </div>

        <!-- 关注提示 (首次进入显示) -->
        <div id="follow-prompt" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fa fa-info-circle text-yellow-400 text-xl"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        欢迎来到诗词大挑战！关注公众号即可开始游戏，无限答题机会，答对一题得10分，答错一题扣6分！
                    </p>
                    <div class="mt-3 flex justify-center">
                        <div class="bg-white p-2 rounded-lg shadow-md inline-block">
                            <img src="https://picsum.photos/150/150?random=1" alt="公众号二维码" class="w-32 h-32">
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <button id="confirm-follow" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            已关注，开始挑战
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 游戏区域 -->
        <div id="game-area" class="hidden">
            <!-- 诗词题目 -->
            <div class="bg-blue-50 p-5 rounded-lg mb-6 min-h-[120px] flex items-center justify-center">
                <div id="poem-container" class="text-center text-gray-800 text-lg leading-relaxed"></div>
            </div>

            <!-- 选项区域 -->
            <div id="options-container" class="grid grid-cols-2 gap-3 mb-6"></div>

            <!-- 反馈区域 -->
            <div id="feedback" class="text-center font-medium min-h-[24px] mb-6"></div>

            <!-- 操作按钮 -->
            <div class="flex gap-3">
                <button id="next-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors hidden">
                    下一题
                </button>
                <button id="share-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded transition-colors flex items-center justify-center">
                    <i class="fa fa-share-alt mr-2"></i>
                    分享继续答题
                </button>
            </div>
        </div>

        <!-- 排行榜区域 -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                <i class="fa fa-trophy text-yellow-500 mr-2"></i>
                诗词达人榜
            </h2>
            <div id="ranking-container" class="bg-gray-50 rounded-lg p-4 max-h-[300px] overflow-y-auto">
                <div id="ranking-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- 底部导航 -->
        <footer class="mt-8 py-4 border-t border-gray-200">
            <div class="flex justify-around">
                <button id="home-btn" class="flex flex-col items-center text-blue-500">
                    <i class="fa fa-home text-xl"></i>
                    <span class="text-xs mt-1">首页</span>
                </button>
                <button id="ranking-btn" class="flex flex-col items-center text-gray-500">
                    <i class="fa fa-list text-xl"></i>
                    <span class="text-xs mt-1">排行榜</span>
                </button>
                <button id="user-btn" class="flex flex-col items-center text-gray-500">
                    <i class="fa fa-user text-xl"></i>
                    <span class="text-xs mt-1">我的</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- 管理员入口 (隐藏) -->
    <div class="fixed bottom-4 right-4 opacity-0 hover:opacity-100 transition-opacity">
        <button id="admin-btn" class="bg-red-500 text-white p-3 rounded-full shadow-lg">
            <i class="fa fa-cog"></i>
        </button>
    </div>

    <!-- 微信JS-SDK -->
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    
    <script>
        // 微信分享功能配置
        const wechatShareConfig = {
            // 这里需要生产环境中，这些参数需要从后端动态获取
            appId: 'wx1234567890abcdef', // 请替换为真实的公众号appId
            timestamp: Math.floor(Date.now() / 1000),
            nonceStr: Math.random().toString(36).substr(2, 15),
            signature: '', // 请生产环境中，这个签名需要从后端获取
            
            // 分享配置
            shareConfig: {
                title: '诗词大挑战 - 来和我一起挑战诗词功底吧！',
                desc: '无限答题机会，答对一题得10分，答错一题扣6分，分享可继续答题！',
                link: window.location.href,
                imgUrl: 'https://picsum.photos/200/200?random=100', // 分享图标
                
                // 分享成功回调
                success: function() {
                    console.log('分享成功');
                    // 记录分享成功
                    gameData.recordShareSuccess();
                },
                
                // 分享取消回调
                cancel: function() {
                    console.log('分享取消');
                }
            }
        };
        
        // 初始化微信分享
        function initWechatShare() {
            // 检查是否在微信环境中
            if (typeof WeixinJSBridge === 'undefined') {
                console.log('不在微信环境中，无法使用微信分享功能');
                return false;
            }
            
            // 配置微信JS-SDK
            wx.config({
                debug: false, // 生产环境中改为false
                appId: wechatShareConfig.appId,
                timestamp: wechatShareConfig.timestamp,
                nonceStr: wechatShareConfig.nonceStr,
                signature: wechatShareConfig.signature,
                jsApiList: [
                    'updateAppMessageShareData', // 分享给朋友
                    'updateTimelineShareData',  // 分享到朋友圈
                    'onMenuShareAppMessage',    // 旧兼容旧版本
                    'onMenuShareTimeline'       // 兼容旧版本
                ]
            });
            
            // 微信JS-SDK配置成功
            wx.ready(function() {
                console.log('微信JS-SDK配置成功');
                
                // 分享给朋友
                wx.updateAppMessageShareData({
                    title: wechatShareConfig.shareConfig.title,
                    desc: wechatShareConfig.shareConfig.desc,
                    link: wechatShareConfig.shareConfig.link,
                    imgUrl: wechatShareConfig.shareConfig.imgUrl,
                    success: wechatShareConfig.shareConfig.success,
                    cancel: wechatShareConfig.shareConfig.cancel
                });
                
                // 分享到朋友圈
                wx.updateTimelineShareData({
                    title: wechatShareConfig.shareConfig.title,
                    link: wechatShareConfig.shareConfig.link,
                    imgUrl: wechatShareConfig.shareConfig.imgUrl,
                    success: wechatShareConfig.shareConfig.success,
                    cancel: wechatShareConfig.shareConfig.cancel
                });
                
                // 兼容旧版本
                wx.onMenuShareAppMessage(wechatShareConfig.shareConfig);
                wx.onMenuShareTimeline(wechatShareConfig.shareConfig);
            });
            
            // 微信JS-SDK配置失败
            wx.error(function(res) {
                console.error('微信JS-SDK配置失败:', res);
            });
            
            return true;
        }
        
        // 游戏数据
        const gameData = {
            // 数据同步设置
            syncSettings: {
                enableAutoSync: true,  // 启用自动同步
                syncInterval: 300000,  // 自动同步间隔（毫秒），默认5分钟
                lastSyncTime: null,    // 上次同步时间
                syncToken: null        // 同步令牌，用于验证用户身份
            },
            // 诗词题库
            poems: [
                {
                    text: "床前明月光，疑是地上___。举头望明月，低头思___。",
                    blanks: ["霜", "故乡"],
                    options: ["霜", "雪", "故乡", "亲人"],
                    author: "李白",
                    title: "静夜思"
                },
                {
                    text: "春眠不觉晓，处处闻啼___。夜来风雨声，花落知___。",
                    blanks: ["鸟", "多少"],
                    options: ["鸟", "虫", "多少", "几何"],
                    author: "孟浩然",
                    title: "春晓"
                },
                {
                    text: "锄禾日当午，汗滴禾下___。谁知盘中餐，粒粒皆___。",
                    blanks: ["土", "辛苦"],
                    options: ["土", "田", "辛苦", "甘甜"],
                    author: "李绅",
                    title: "悯农"
                },
                {
                    text: "白日依山尽，黄河入海___。欲穷千里目，更上一层___。",
                    blanks: ["流", "楼"],
                    options: ["流", "海", "楼", "台"],
                    author: "王之涣",
                    title: "登鹳雀楼"
                },
                {
                    text: "两个黄鹂鸣翠柳，一行白鹭上青___。窗含西岭千秋雪，门泊东吴万里___。",
                    blanks: ["天", "船"],
                    options: ["天", "云", "船", "车"],
                    author: "杜甫",
                    title: "绝句"
                },
                {
                    text: "远上寒山石径斜，白云生处有人___。停车坐爱枫林晚，霜叶红于二月___。",
                    blanks: ["家", "花"],
                    options: ["家", "户", "花", "叶"],
                    author: "杜牧",
                    title: "山行"
                },
                {
                    text: "清明时节雨纷纷，路上行人欲断___。借问酒家何处有，牧童遥指杏花___。",
                    blanks: ["魂", "村"],
                    options: ["魂", "肠", "村", "庄"],
                    author: "杜牧",
                    title: "清明"
                },
                {
                    text: "不识庐山真面目，只缘身在此山___。",
                    blanks: ["中"],
                    options: ["中", "上", "里", "间"],
                    author: "苏轼",
                    title: "题西林壁"
                },
                {
                    text: "小荷才露尖尖角，早有蜻蜓立上___。",
                    blanks: ["头"],
                    options: ["头", "尖", "顶", "端"],
                    author: "杨万里",
                    title: "小池"
                },
                {
                    text: "爆竹声中一岁除，春风送暖入屠___。千门万户曈曈日，总把新桃换旧___。",
                    blanks: ["苏", "符"],
                    options: ["苏", "家", "符", "联"],
                    author: "王安石",
                    title: "元日"
                }
            ],
            
            // 当前游戏状态
            currentPoem: null,
            userAnswers: [],
            score: 0,
            attempts: 0,  // 仅用于计数，不做限制
            userId: null,
            userName: null,
            isGameStarted: false,
            // 分享相关
            shareCount: 0,
            maxDailyShares: 3, // 每日最多分享次数
            isShareInProgress: false,
            // 新增：当前填空索引
            currentBlankIndex: 0,
            
            // 初始化游戏
            init() {
                // 生成或获取用户ID
                this.userId = localStorage.getItem('literaryGameUserId');
                if (!this.userId) {
                    this.userId = 'user_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                    localStorage.setItem('literaryGameUserId', this.userId);
                }
                
                // 获取用户名
                this.userName = localStorage.getItem('literaryGameUserName') || '诗词爱好者' + Math.floor(Math.random() * 1000);
                
                // 加载用户数据
                this.loadUserData();
                
                // 加载同步设置
                this.loadSyncSettings();
                
                // 初始化界面
                this.initUI();
                
                // 检查是否首次进入
                const hasVisited = localStorage.getItem('literaryGameHasVisited');
                if (!hasVisited) {
                    // 首次进入，显示关注提示
                    document.getElementById('follow-prompt').classList.remove('hidden');
                    localStorage.setItem('literaryGameHasVisited', 'true');
                } else {
                    // 不是首次进入，直接显示游戏区域
                    document.getElementById('follow-prompt').classList.add('hidden');
                    document.getElementById('game-area').classList.remove('hidden');
                    this.startGame();
                    
                    // 检查是否需要同步数据
                    this.checkDataSync();
                }
            },
            
            // 加载用户数据
            loadUserData() {
                const savedScore = localStorage.getItem('literaryGameScore_' + this.userId);
                const savedAttempts = localStorage.getItem('literaryGameAttempts_' + this.userId);
                const lastPlayDate = localStorage.getItem('literaryGameLastPlayDate_' + this.userId);
                const savedShareCount = localStorage.getItem('literaryGameShareCount_' + this.userId);
                const lastShareDate = localStorage.getItem('literaryGameLastShareDate_' + this.userId);
                
                if (savedScore) this.score = parseInt(savedScore);
                if (savedAttempts) this.attempts = parseInt(savedAttempts);
                if (savedShareCount) this.shareCount = parseInt(savedShareCount);
                
                // 检查是否是新的一天，重置分享次数
                const today = new Date().toDateString();
                if (lastShareDate !== today) {
                    this.shareCount = 0;
                    localStorage.setItem('literaryGameLastShareDate_' + this.userId, today);
                }
                
                // 更新界面显示
                document.getElementById('score-display').textContent = this.score;
                document.getElementById('attempts-display').textContent = this.attempts;
            },
            
            // 初始化界面
            initUI() {
                // 更新排名
                this.updateRanking();
                
                // 绑定事件
                this.bindEvents();
            },
            
            // 绑定事件
            bindEvents() {
                // 确认关注按钮
                document.getElementById('confirm-follow').addEventListener('click', () => {
                    document.getElementById('follow-prompt').classList.add('hidden');
                    document.getElementById('game-area').classList.remove('hidden');
                    this.startGame();
                    
                    // 检查是否需要同步数据
                    this.checkDataSync();
                });
                
                // 分享按钮
                document.getElementById('share-btn').addEventListener('click', () => {
                    this.shareToAddAttempt();
                });
                
                // 下一题按钮
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.loadNewPoem();
                });
                
                // 规则按钮
                document.getElementById('rules-btn').addEventListener('click', () => {
                    this.showRules();
                });
                
                // 底部导航按钮
                document.getElementById('home-btn').addEventListener('click', () => {
                    // 已在首页
                });
                
                document.getElementById('ranking-btn').addEventListener('click', () => {
                    document.getElementById('ranking-container').scrollIntoView({ behavior: 'smooth' });
                });
                
                document.getElementById('user-btn').addEventListener('click', () => {
                    this.showUserInfo();
                });
                
                // 管理员按钮
                document.getElementById('admin-btn').addEventListener('click', () => {
                    this.showAdminPanel();
                });
            },
            
            // 开始游戏
            startGame() {
                this.isGameStarted = true;
                this.loadNewPoem();
            },
            
            // 加载新诗词
            loadNewPoem() {
                // 检查分数是否为负，如果是则需要分享
                if (this.score < 0) {
                    this.showFeedback('您的分数为负数，请先分享以继续答题！', 'red');
                    document.getElementById('next-btn').classList.add('hidden');
                    document.getElementById('share-btn').classList.remove('hidden');
                    return;
                }
                
                // 重置答题状态
                this.userAnswers = [];
                this.currentBlankIndex = 0;
                this.showFeedback('');
                
                // 隐藏下一题按钮
                document.getElementById('next-btn').classList.add('hidden');
                
                // 随机选择一首诗词
                const randomIndex = Math.floor(Math.random() * this.poems.length);
                this.currentPoem = this.poems[randomIndex];
                
                // 显示诗词（带填空）
                const poemContainer = document.getElementById('poem-container');
                const poemText = this.currentPoem.text;
                
                // 将诗词文本转换为带填空的HTML
                let blankIndex = 0;
                const poemWithBlanks = poemText.replace(/___/g, () => {
                    return `<span class="blank-space empty" data-index="${blankIndex++}">___</span>`;
                });
                
                poemContainer.innerHTML = `
                    <p class="mb-2">${poemWithBlanks}</p>
                    <p class="text-sm text-gray-500">—— ${this.currentPoem.author} 《${this.currentPoem.title}》</p>
                `;
                
                // 显示选项
                const optionsContainer = document.getElementById('options-container');
                optionsContainer.innerHTML = '';
                
                // 随机排序选项
                const shuffledOptions = [...this.currentPoem.options].sort(() => Math.random() - 0.5);
                
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-colors';
                    button.textContent = option;
                    button.onclick = () => this.selectOption(option);
                    optionsContainer.appendChild(button);
                });
                
                // 显示分享按钮，方便随时分享
                document.getElementById('share-btn').classList.remove('hidden');
            },
            
            // 选择选项
            selectOption(option) {
                if (this.currentBlankIndex < this.currentPoem.blanks.length) {
                    // 将答案填入当前空白处
                    this.userAnswers[this.currentBlankIndex] = option;
                    
                    // 更新填空显示
                    const blankSpaces = document.querySelectorAll('.blank-space');
                    blankSpaces[this.currentBlankIndex].textContent = option;
                    blankSpaces[this.currentBlankIndex].classList.remove('empty');
                    blankSpaces[this.currentBlankIndex].classList.add('filled');
                    
                    // 移动到下一个填空
                    this.currentBlankIndex++;
                    
                    // 检查是否完成答题
                    if (this.currentBlankIndex === this.currentPoem.blanks.length) {
                        this.attempts++;  // 增加答题次数计数
                        document.getElementById('attempts-display').textContent = this.attempts;
                        
                        // 保存答题次数
                        localStorage.setItem('literaryGameAttempts_' + this.userId, this.attempts);
                        
                        // 记录总答题次数
                        let totalAttemptsCount = parseInt(localStorage.getItem('literaryGameTotalAttempts') || '0');
                        totalAttemptsCount++;
                        localStorage.setItem('literaryGameTotalAttempts', totalAttemptsCount);
                        
                        // 检查答案
                        const isCorrect = this.userAnswers.every((answer, index) => answer === this.currentPoem.blanks[index]);
                        
                        if (isCorrect) {
                            // 答对了，加10分
                            this.score += 10;
                            document.getElementById('score-display').textContent = this.score;
                            this.showFeedback(`恭喜你，答对了！加10分！当前得分: ${this.score}`, 'green');
                            
                            // 保存分数
                            localStorage.setItem('literaryGameScore_' + this.userId, this.score);
                            
                            // 记录总答对次数
                            let totalCorrectCount = parseInt(localStorage.getItem('literaryGameTotalCorrect') || '0');
                            totalCorrectCount++;
                            localStorage.setItem('literaryGameTotalCorrect', totalCorrectCount);
                            
                            // 更新用户排名
                            this.updateUserRanking();
                        } else {
                            // 答错了，扣6分
                            this.score -= 6;
                            document.getElementById('score-display').textContent = this.score;
                            const correctAnswer = this.currentPoem.blanks.join('、');
                            this.showFeedback(`答错了，正确答案是：${correctAnswer}，扣6分！当前得分: ${this.score}`, 'red');
                            
                            // 保存分数
                            localStorage.setItem('literaryGameScore_' + this.userId, this.score);
                        }
                        
                        // 显示下一题按钮
                        document.getElementById('next-btn').classList.remove('hidden');
                    }
                }
            },
            
            // 显示反馈
            showFeedback(message, type = 'default') {
                const feedbackElement = document.getElementById('feedback');
                feedbackElement.textContent = message;
                
                // 设置样式
                feedbackElement.className = 'text-center font-medium min-h-[24px] mb-6';
                
                if (type === 'green') {
                    feedbackElement.classList.add('text-green-600');
                } else if (type === 'red') {
                    feedbackElement.classList.add('text-red-600');
                } else if (type === 'yellow') {
                    feedbackElement.classList.add('text-yellow-600');
                }
            },
            
            // 分享继续答题
            shareToAddAttempt() {
                // 检查是否在微信环境中
                if (typeof WeixinJSBridge === 'undefined') {
                    this.showFeedback('请在微信中打开以使用分享功能', 'red');
                    return;
                }
                
                // 检查每日分享次数限制
                if (this.shareCount >= this.maxDailyShares) {
                    this.showFeedback(`今日分享次数已达上限(${this.maxDailyShares}次)，明天再来吧！`, 'red');
                    return;
                }
                
                // 检查是否正在分享中
                if (this.isShareInProgress) {
                    this.showFeedback('分享正在进行中，请稍候...', 'yellow');
                    return;
                }
                
                // 标记分享开始
                this.isShareInProgress = true;
                
                // 更新分享链接，包含用户ID用于邀请统计
                const shareLink = new URL(window.location.href);
                shareLink.searchParams.set('inviter', this.userId);
                wechatShareConfig.shareConfig.link = shareLink.toString();
                
                // 初始化微信分享
                const wechatShareInitialized = initWechatShare();
                
                if (!wechatShareInitialized) {
                    this.isShareInProgress = false;
                    this.showFeedback('微信分享功能初始化失败，请稍后重试', 'red');
                    return;
                }
                
                // 显示分享引导弹窗
                const overlay = document.getElementById('overlay');
                const overlayContent = document.getElementById('overlay-content');
                
                overlayContent.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-xl font-bold mb-4">分享给好友</h3>
                        <p class="mb-4">请点击右上角 <i class="fa fa-ellipsis-h text-blue-500"></i> 分享到微信群或朋友圈，分享成功后即可继续答题！</p>
                        <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-yellow-700">
                                <i class="fa fa-info-circle text-yellow-500 mr-1"></i>
                                每日最多可分享${this.maxDailyShares}次，当前已分享${this.shareCount}次
                            </p>
                        </div>
                        <div class="flex justify-center gap-4 mb-4">
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-2">
                                    <i class="fa fa-wechat text-green-500 text-2xl"></i>
                                </div>
                                <span class="text-sm">分享给好友</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-2">
                                    <i class="fa fa-share-alt text-green-500 text-2xl"></i>
                                </div>
                                <span class="text-sm">分享到朋友圈</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">分享后请返回游戏继续答题</p>
                        <button id="cancel-share" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            取消
                        </button>
                    </div>
                `;
                
                overlay.classList.remove('hidden');
                
                // 绑定取消分享按钮事件
                document.getElementById('cancel-share').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    this.isShareInProgress = false;
                });
                
                // 30秒后自动关闭分享弹窗（防止用户忘记关闭）
                setTimeout(() => {
                    if (this.isShareInProgress) {
                        overlay.classList.add('hidden');
                        this.isShareInProgress = false;
                        this.showFeedback('分享已超时，请重新尝试', 'red');
                    }
                }, 30000);
            },
            
            // 记录分享成功
            recordShareSuccess() {
                // 检查是否在分享过程中
                if (!this.isShareInProgress) {
                    console.log('不是在分享过程中，忽略分享成功事件');
                    return;
                }
                
                // 标记分享结束
                this.isShareInProgress = false;
                
                // 关闭分享弹窗
                const overlay = document.getElementById('overlay');
                overlay.classList.add('hidden');
                
                // 增加分享次数
                this.shareCount++;
                localStorage.setItem('literaryGameShareCount_' + this.userId, this.shareCount);
                
                // 显示反馈
                this.showFeedback('分享成功！可以继续答题了！', 'green');
                
                // 如果分数为负，给予一点鼓励分
                if (this.score < 0) {
                    this.score += 5;
                    document.getElementById('score-display').textContent = this.score;
                    localStorage.setItem('literaryGameScore_' + this.userId, this.score);
                    this.showFeedback('分享成功！获得5分鼓励分，可以继续答题了！当前得分: ' + this.score, 'green');
                }
                
                // 加载新题目
                setTimeout(() => this.loadNewPoem(), 1000);
            },
            
            // 记录邀请统计
            recordInvitation() {
                // 检查URL参数中是否有邀请者ID
                const urlParams = new URLSearchParams(window.location.search);
                const inviterId = urlParams.get('inviter');
                
                if (inviterId && inviterId !== this.userId) {
                    // 获取已有的邀请统计
                    let invitationStats = JSON.parse(localStorage.getItem('literaryGameInvitationStats') || '{}');
                    
                    // 更新邀请者的邀请次数
                    if (!invitationStats[inviterId]) {
                        invitationStats[inviterId] = {
                            count: 0,
                            users: []
                        };
                    }
                    
                    // 检查是否已经记录过这个邀请
                    if (!invitationStats[inviterId].users.includes(this.userId)) {
                        invitationStats[inviterId].count++;
                        invitationStats[inviterId].users.push(this.userId);
                        
                        // 保存邀请统计
                        localStorage.setItem('literaryGameInvitationStats', JSON.stringify(invitationStats));
                        
                        console.log(`用户 ${this.userId} 由邀请者 ${inviterId} 邀请`);
                    }
                }
            },
            
            // 更新用户排名
            updateUserRanking() {
                let ranking = JSON.parse(localStorage.getItem('literaryGameRanking') || '[]');
                
                // 更新当前用户分数或添加新用户
                const userIndex = ranking.findIndex(user => user.id === this.userId);
                if (userIndex !== -1) {
                    ranking[userIndex].score = this.score;
                } else {
                    ranking.push({ 
                        id: this.userId, 
                        name: this.userName, 
                        score: this.score,
                        lastPlay: new Date().toISOString()
                    });
                    
                    // 记录总用户数
                    let totalUsersCount = parseInt(localStorage.getItem('literaryGameTotalUsers') || '0');
                    totalUsersCount++;
                    localStorage.setItem('literaryGameTotalUsers', totalUsersCount);
                }
                
                // 按分数排序
                ranking.sort((a, b) => b.score - a.score);
                
                // 保存排名
                localStorage.setItem('literaryGameRanking', JSON.stringify(ranking));
                
                // 更新排行榜显示
                this.updateRanking();
            },
            
            // 更新排行榜显示
            updateRanking() {
                let ranking = JSON.parse(localStorage.getItem('literaryGameRanking') || '[]');
                const rankingList = document.getElementById('ranking-list');
                rankingList.innerHTML = '';
                
                // 只显示前10名
                const topRanking = ranking.slice(0, 10);
                
                if (topRanking.length === 0) {
                    rankingList.innerHTML = '<p class="text-center text-gray-500 py-4">暂无排名数据</p>';
                    return;
                }
                
                topRanking.forEach((user, index) => {
                    const item = document.createElement('div');
                    item.className = `flex justify-between items-center p-2 rounded-lg ${user.id === this.userId ? 'bg-blue-50 font-bold' : 'bg-white'}`;
                    
                    // 排名图标
                    let rankIcon = '';
                    if (index === 0) {
                        rankIcon = '<i class="fa fa-trophy text-yellow-500 mr-2"></i>';
                    } else if (index === 1) {
                        rankIcon = '<i class="fa fa-trophy text-gray-400 mr-2"></i>';
                    } else if (index === 2) {
                        rankIcon = '<i class="fa fa-trophy text-orange-300 mr-2"></i>';
                    } else {
                        rankIcon = `<span class="w-6 text-center mr-2">${index + 1}</span>`;
                    }
                    
                    item.innerHTML = `
                        <div class="flex items-center">
                            ${rankIcon}
                            <span>${user.name}</span>
                        </div>
                        <span class="text-blue-600 font-bold">${user.score}分</span>
                    `;
                    
                    rankingList.appendChild(item);
                    
                    // 更新当前用户排名
                    if (user.id === this.userId) {
                        document.getElementById('rank-display').textContent = `${index + 1}名`;
                    }
                });
            },
            
            // 显示规则
            showRules() {
                const overlay = document.getElementById('overlay');
                const overlayContent = document.getElementById('overlay-content');
                
                overlayContent.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-4">游戏规则</h3>
                        <ul class="list-disc pl-5 space-y-2 mb-4">
                            <li>无限答题机会，随时可以挑战</li>
                            <li>每答对一题获得10分</li>
                            <li>每答错一题扣6分</li>
                            <li>当分数为负数时，需要分享才能继续答题</li>
                            <li>积分排名前10的用户将显示在排行榜上</li>
                            <li>管理员可查看所有用户数据</li>
                        </ul>
                        <button id="close-rules" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            我知道了
                        </button>
                    </div>
                `;
                
                overlay.classList.remove('hidden');
                
                // 绑定关闭按钮事件
                document.getElementById('close-rules').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                });
            },
            
            // 显示用户信息
            showUserInfo() {
                const overlay = document.getElementById('overlay');
                const overlayContent = document.getElementById('overlay-content');
                
                overlayContent.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-4">个人中心</h3>
                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <div class="flex items-center mb-3">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl font-bold mr-3">
                                    ${this.userName.charAt(0)}
                                </div>
                                <div>
                                    <p class="font-medium">${this.userName}</p>
                                    <p class="text-sm text-gray-500">用户ID: ${this.userId.slice(-6)}</p>
                                </div>
                            </div>
                            <div class="flex justify-between text-sm">
                                <div class="text-center">
                                    <p class="font-bold text-blue-600">${this.score}</p>
                                    <p class="text-gray-500">总积分</p>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-green-600">${this.attempts}</p>
                                    <p class="text-gray-500">总答题次数</p>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-purple-600">${this.getRank()}</p>
                                    <p class="text-gray-500">当前排名</p>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="user-name-input" class="block text-gray-700 mb-2">修改昵称</label>
                            <input type="text" id="user-name-input" class="w-full border border-gray-300 rounded-lg px-3 py-2" value="${this.userName}">
                        </div>
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-gray-700">自动同步数据</label>
                                <div class="relative inline-block w-12 align-middle select-none">
                                    <input type="checkbox" id="auto-sync-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-0 appearance-none cursor-pointer right-0 checked:right-0 checked:bg-blue-600 transition-all duration-200 ease-in-out" ${this.syncSettings.enableAutoSync ? 'checked' : ''}>
                                    <label for="auto-sync-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500">启用后，您的游戏数据将自动同步到服务器，用于排行榜和活动统计</p>
                        </div>
                        <button id="save-name" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            保存设置
                        </button>
                    </div>
                `;
                
                overlay.classList.remove('hidden');
                
                // 绑定保存设置按钮事件
                document.getElementById('save-name').addEventListener('click', () => {
                    const newName = document.getElementById('user-name-input').value.trim();
                    const autoSyncEnabled = document.getElementById('auto-sync-toggle').checked;
                    
                    // 保存昵称
                    if (newName && newName.length <= 10) {
                        this.userName = newName;
                        localStorage.setItem('literaryGameUserName', newName);
                        
                        // 更新排名中的用户名
                        let ranking = JSON.parse(localStorage.getItem('literaryGameRanking') || '[]');
                        const userIndex = ranking.findIndex(user => user.id === this.userId);
                        if (userIndex !== -1) {
                            ranking[userIndex].name = newName;
                            localStorage.setItem('literaryGameRanking', JSON.stringify(ranking));
                        }
                    }
                    
                    // 保存自动同步设置
                    if (autoSyncEnabled !== this.syncSettings.enableAutoSync) {
                        this.syncSettings.enableAutoSync = autoSyncEnabled;
                        this.saveSyncSettings();
                        
                        // 如果启用了同步，立即同步一次数据
                        if (autoSyncEnabled && this.syncSettings.syncToken) {
                            this.uploadUserData();
                        }
                    }
                    
                    // 更新排行榜显示
                    this.updateRanking();
                    
                    overlay.classList.add('hidden');
                    
                    // 显示保存成功提示
                    if (newName && newName.length <= 10) {
                        alert('设置保存成功！');
                    } else if (autoSyncEnabled !== this.syncSettings.enableAutoSync) {
                        alert('同步设置已更新！');
                    }
                });
            },
            
            // 获取当前用户排名
            getRank() {
                let ranking = JSON.parse(localStorage.getItem('literaryGameRanking') || '[]');
                const userIndex = ranking.findIndex(user => user.id === this.userId);
                return userIndex !== -1 ? (userIndex + 1) + '名' : '未上榜';
            },
            
            // 加载同步设置
            loadSyncSettings() {
                const savedSyncSettings = localStorage.getItem('literaryGameSyncSettings');
                if (savedSyncSettings) {
                    const parsedSettings = JSON.parse(savedSyncSettings);
                    this.syncSettings.enableAutoSync = parsedSettings.enableAutoSync !== undefined ? parsedSettings.enableAutoSync : true;
                    this.syncSettings.syncInterval = parsedSettings.syncInterval || 300000;
                    this.syncSettings.lastSyncTime = parsedSettings.lastSyncTime;
                    this.syncSettings.syncToken = parsedSettings.syncToken;
                }
                
                // 如果启用了自动同步，设置定时同步
                if (this.syncSettings.enableAutoSync) {
                    this.setupAutoSync();
                }
            },
            
            // 设置自动同步
            setupAutoSync() {
                // 清除之前的定时器
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                }
                
                // 设置新的定时器
                this.syncTimer = setInterval(() => {
                    this.checkDataSync();
                }, this.syncSettings.syncInterval);
            },
            
            // 保存同步设置
            saveSyncSettings() {
                localStorage.setItem('literaryGameSyncSettings', JSON.stringify({
                    enableAutoSync: this.syncSettings.enableAutoSync,
                    syncInterval: this.syncSettings.syncInterval,
                    lastSyncTime: this.syncSettings.lastSyncTime,
                    syncToken: this.syncSettings.syncToken
                }));
                
                // 根据设置启用或禁用自动同步
                this.setupAutoSync();
            },
            
            // 检查是否需要同步数据
            checkDataSync() {
                // 如果用户已同意同步
                if (this.syncSettings.syncToken) {
                    const now = new Date().getTime();
                    const lastSync = this.syncSettings.lastSyncTime ? new Date(this.syncSettings.lastSyncTime).getTime() : 0;
                    
                    // 如果距离上次同步超过了同步间隔，或者从未同步过
                    if (now - lastSync > this.syncSettings.syncInterval || lastSync === 0) {
                        this.uploadUserData();
                    }
                } else {
                    // 检查用户是否已做出选择
                    const hasDecidedSync = localStorage.getItem('literaryGameHasDecidedSync');
                    if (!hasDecidedSync) {
                        // 用户尚未做出选择，显示同步请求
                        this.requestSyncConsent();
                    }
                }
            },
            
            // 请求用户同意同步数据
            requestSyncConsent() {
                const overlay = document.getElementById('overlay');
                const overlayContent = document.getElementById('overlay-content');
                
                overlayContent.innerHTML = `
                    <div>
                        <div class="flex items-center justify-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center items text-white text-2xl font-bold">
                                <i class="fa fa-book"></i>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-center">沧海墨客</h3>
                        <p class="text-center text-gray-600 mb-4">同步数据参与积分排名获好礼！</p>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 rounded">
                            <p class="text-sm text-yellow-800">
                                <i class="fa fa-gift text-yellow-500 mr-1"></i>
                                <strong>同步数据享三重福利：</strong>参与全国诗词达人积分排名、每周获取专属勋章、有机会不定期获得文学好礼！
                            </p>
                        </div>
                        
                        <p class="mb-4">同步您的游戏数据，即可参与"沧海墨客"公众号的诗词排行榜，与全国诗词爱好者一起比拼诗词功底！</p>
                        <p class="mb-4 text-sm text-gray-600">
                            <i class="fa fa-info-circle text-blue-500 mr-1"></i>
                            <strong>隐私保障：</strong>仅同步您的游戏昵称、积分和排名数据，不会收集个人敏感信息。您可以随时在"我的"页面中关闭数据同步。
                        </p>
                        
                        <div class="flex gap-3">
                            <button id="agree-sync" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium py-2 px-4 rounded transition-colors flex items-center justify-center">
                                <i class="fa fa-sync mr-2"></i>
                                立即同步，参与排名
                            </button>
                            <button id="decline-sync" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded transition-colors">
                                稍后再说
                            </button>
                        </div>
                    </div>
                `;
                
                overlay.classList.remove('hidden');
                
                // 绑定同意按钮事件
                document.getElementById('agree-sync').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    localStorage.setItem('literaryGameHasDecidedSync', 'true');
                    
                    // 生成同步令牌
                    this.syncSettings.syncToken = 'sync_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    this.syncSettings.lastSyncTime = new Date().toISOString();
                    this.saveSyncSettings();
                    
                    // 首次同步数据
                    this.uploadUserData();
                });
                
                // 绑定拒绝按钮事件
                document.getElementById('decline-sync').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                    localStorage.setItem('literaryGameHasDecidedSync', 'true');
                    
                    // 用户不同意同步
                    this.syncSettings.enableAutoSync = false;
                    this.syncSettings.syncToken = null;
                    this.saveSyncSettings();
                });
            },
            
            // 上传用户数据
            uploadUserData() {
                // 准备要上传的数据
                const userData = {
                    userId: this.userId,
                    userName: this.userName,
                    score: this.score,
                    attempts: this.attempts,
                    lastPlay: new Date().toISOString(),
                    syncToken: this.syncSettings.syncToken
                };
                
                try {
                    // 尝试从URL参数获取管理员的同步密钥
                    const urlParams = new URLSearchParams(window.location.search);
                    const adminSyncKey = urlParams.get('syncKey');
                    
                    if (adminSyncKey) {
                        // 如果URL中包含同步密钥，直接存储到localStorage的特定位置
                        // 这是一个简化的实现，实际应用中应该使用更安全的方式
                        const adminDataStoreKey = 'literaryGameAdminData_' + adminSyncKey;
                        
                        // 获取现有的管理员数据
                        let adminData = JSON.parse(localStorage.getItem(adminDataStoreKey) || '{}');
                        
                        // 更新用户数据
                        adminData.users = adminData.users || {};
                        adminData.users[this.userId] = userData;
                        
                        // 更新统计数据
                        adminData.stats = adminData.stats || {
                            totalUsers: 0,
                            totalAttempts: 0,
                            totalCorrect: 0,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        // 计算用户数量
                        adminData.stats.totalUsers = Object.keys(adminData.users).length;
                        
                        // 保存更新后的数据
                        localStorage.setItem(adminDataStoreKey, JSON.stringify(adminData));
                        
                        // 更新同步时间
                        this.syncSettings.lastSyncTime = new Date().toISOString();
                        this.saveSyncSettings();
                        
                        console.log('用户数据已成功同步到管理员:', userData);
                    } else {
                        // 如果没有同步密钥，尝试使用localStorage共享
                        // 这只在同一浏览器中有效，主要用于演示
                        let sharedData = JSON.parse(localStorage.getItem('literaryGameSharedData') || '{}');
                        
                        // 更新用户数据
                        sharedData.users = sharedData.users || {};
                        sharedData.users[this.userId] = userData;
                        
                        // 更新统计数据
                        sharedData.stats = sharedData.stats || {
                            totalUsers: 0,
                            totalAttempts: 0,
                            totalCorrect: 0,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        // 计算用户数量
                        sharedData.stats.totalUsers = Object.keys(sharedData.users).length;
                        
                        // 保存更新后的数据
                        localStorage.setItem('literaryGameSharedData', JSON.stringify(sharedData));
                        
                        // 更新同步时间
                        this.syncSettings.lastSyncTime = new Date().toISOString();
                        this.saveSyncSettings();
                        
                        console.log('用户数据已成功同步到本地共享存储:', userData);
                    }
                } catch (error) {
                    console.error('数据同步失败:', error);
                }
            },
            
            // 接收管理员数据（用于排行榜更新）
            receiveAdminData() {
                try {
                    // 尝试从URL参数获取管理员的同步密钥
                    const urlParams = new URLSearchParams(window.location.search);
                    const adminSyncKey = urlParams.get('syncKey');
                    
                    let sharedData;
                    
                    if (adminSyncKey) {
                        // 如果URL中包含同步密钥，从特定位置获取
                        const adminDataStoreKey = 'literaryGameAdminData_' + adminSyncKey;
                        sharedData = JSON.parse(localStorage.getItem(adminDataStoreKey) || '{}');
                    } else {
                        // 否则从本地共享存储获取
                        sharedData = JSON.parse(localStorage.getItem('literaryGameSharedData') || '{}');
                    }
                    
                    if (sharedData && sharedData.users) {
                        // 将接收到的用户数据转换为排行榜格式
                        const ranking = Object.values(sharedData.users)
                            .sort((a, b) => b.score - a.score)
                            .map(user => ({
                                id: user.userId,
                                name: user.userName,
                                score: user.score,
                                lastPlay: user.lastPlay
                            }));
                        
                        // 保存到本地排名
                        localStorage.setItem('literaryGameRanking', JSON.stringify(ranking));
                        
                        // 更新排行榜显示
                        this.updateRanking();
                        
                        console.log('已从管理员接收并更新排行榜数据');
                        return true;
                    }
                } catch (error) {
                    console.error('接收管理员数据失败:', error);
                }
                
                return false;
            },
            
            // 显示管理员面板
            showAdminPanel() {
                const overlay = document.getElementById('overlay');
                const overlayContent = document.getElementById('overlay-content');
                
                overlayContent.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-4">管理员面板</h3>
                        <div class="mb-4">
                            <label for="admin-password" class="block text-gray-700 mb-2">请输入管理员密码</label>
                            <input type="password" id="admin-password" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        </div>
                        <button id="admin-login" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors mb-2">
                            登录
                        </button>
                        <button id="close-admin" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            关闭
                        </button>
                    </div>
                `;
                
                overlay.classList.remove('hidden');
                
                // 绑定关闭按钮事件
                document.getElementById('close-admin').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                });
                
                // 绑定登录按钮事件
                document.getElementById('admin-login').addEventListener('click', () => {
                    const password = document.getElementById('admin-password').value;
                    // 这里使用简单的密码验证，实际应用中应使用更安全的方式
                    if (password === 'admin123') {
                        this.showAdminData();
                    } else {
                        alert('密码错误！');
                    }
                });
            },
            
            // 显示管理员数据
            showAdminData() {
                const overlay = document.getElementById('overlay');
                const overlayContent = document.getElementById('overlay-content');
                
                // 获取所有用户数据（包括通过同步上传的）
                let allUserData = {};
                let totalUsers = 0;
                let totalScore = 0;
                let totalAttempts = localStorage.getItem('literaryGameTotalAttempts') || '0';
                let totalCorrect = localStorage.getItem('literaryGameTotalCorrect') || '0';
                let accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) + '%' : '0%';
                
                // 计算总分享次数和总邀请次数
                let totalShares = 0;
                let totalInvitations = 0;
                
                // 获取所有用户的分享次数
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('literaryGameShareCount_')) {
                        totalShares += parseInt(localStorage.getItem(key) || '0');
                    }
                });
                
                // 获取邀请统计
                const invitationStats = JSON.parse(localStorage.getItem('literaryGameInvitationStats') || '{}');
                Object.values(invitationStats).forEach(stat => {
                    totalInvitations += stat.count || 0;
                });
                
                try {
                    // 尝试从URL参数获取管理员的同步密钥
                    const urlParams = new URLSearchParams(window.location.search);
                    const adminSyncKey = urlParams.get('syncKey');
                    
                    if (adminSyncKey) {
                        // 如果URL中包含同步密钥，从特定位置获取
                        const adminDataStoreKey = 'literaryGameAdminData_' + adminSyncKey;
                        const adminData = JSON.parse(localStorage.getItem(adminDataStoreKey) || '{}');
                        
                        if (adminData && adminData.users) {
                            allUserData = adminData.users;
                            totalUsers = Object.keys(allUserData).length;
                            
                            // 计算总分
                            totalScore = Object.values(allUserData).reduce((sum, user) => sum + user.score, 0);
                            
                            // 如果有统计数据，使用管理员数据中的统计
                            if (adminData.stats) {
                                totalAttempts = adminData.stats.totalAttempts || totalAttempts;
                                totalCorrect = adminData.stats.totalCorrect || totalCorrect;
                                accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) + '%' : '0%';
                            }
                        }
                    } else {
                        // 否则从本地共享存储获取
                        const sharedData = JSON.parse(localStorage.getItem('literaryGameSharedData') || '{}');
                        
                        if (sharedData && sharedData.users) {
                            allUserData = sharedData.users;
                            totalUsers = Object.keys(allUserData).length;
                            
                            // 计算总分
                            totalScore = Object.values(allUserData).reduce((sum, user) => sum + user.score, 0);
                            
                            // 如果有统计数据，使用共享数据中的统计
                            if (sharedData.stats) {
                                totalAttempts = sharedData.stats.totalAttempts || totalAttempts;
                                totalCorrect = sharedData.stats.totalCorrect || totalCorrect;
                                accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) + '%' : '0%';
                            }
                        }
                    }
                } catch (error) {
                    console.error('获取管理员数据失败:', error);
                }
                
                // 获取本地排名数据
                let localRanking = JSON.parse(localStorage.getItem('literaryGameRanking') || '[]');
                
                // 合并本地排名和同步的用户数据
                let allUsers = [...localRanking];
                
                // 添加同步数据中没有在本地排名的用户
                Object.values(allUserData).forEach(userData => {
                    if (!allUsers.some(user => user.id === userData.userId)) {
                        allUsers.push({
                            id: userData.userId,
                            name: userData.userName,
                            score: userData.score,
                            lastPlay: userData.lastPlay
                        });
                    }
                });
                
                // 按分数排序
                allUsers.sort((a, b) => b.score - a.score);
                
                // 更新本地排名
                localStorage.setItem('literaryGameRanking', JSON.stringify(allUsers));
                
                overlayContent.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-4">数据统计</h3>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-blue-50 p-3 rounded-lg text-center">
                                <p class="text-sm text-gray-500">总用户数</p>
                                <p class="text-xl font-bold text-blue-600">${totalUsers}</p>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg text-center">
                                <p class="text-sm text-gray-500">总答题次数</p>
                                <p class="text-xl font-bold text-green-600">${totalAttempts}</p>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-lg text-center">
                                <p class="text-sm text-gray-500">总答对次数</p>
                                <p class="text-xl font-bold text-yellow-600">${totalCorrect}</p>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg text-center">
                                <p class="text-sm text-gray-500">正确率</p>
                                <p class="text-xl font-bold text-purple-600">${accuracy}</p>
                            </div>
                            <div class="bg-red-50 p-3 rounded-lg text-center">
                                <p class="text-sm text-gray-500">总分享次数</p>
                                <p class="text-xl font-bold text-red-600">${totalShares}</p>
                            </div>
                            <div class="bg-indigo-50 p-3 rounded-lg text-center">
                                <p class="text-sm text-gray-500">总邀请次数</p>
                                <p class="text-xl font-bold text-indigo-600">${totalInvitations}</p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-bold mb-2">数据同步设置</h4>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="mb-3">
                                    <label for="admin-sync-key" class="block text-sm text-gray-700 mb-1">同步密钥</label>
                                    <div class="flex">
                                        <input type="text" id="admin-sync-key" class="flex-1 border border-gray-300 rounded-l-lg px-3 py-2" value="${urlParams.get('syncKey') || '未设置'}" readonly>
                                        <button id="generate-sync-key" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-r-lg transition-colors">
                                            生成密钥
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">使用此密钥创建用户访问链接，用户数据将同步到您的设备</p>
                                </div>
                                <div class="mb-3">
                                    <label for="user-access-link" class="block text-sm text-gray-700 mb-1">用户访问链接</label>
                                    <div class="flex">
                                        <input type="text" id="user-access-link" class="flex-1 border border-gray-300 rounded-l-lg px-3 py-2" readonly>
                                        <button id="copy-access-link" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-r-lg transition-colors">
                                            复制
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">将此链接发给用户，用户访问后数据将自动同步到此设备</p>
                                </div>
                                <div class="flex items-center">
                                    <button id="qr-code-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded transition-colors">
                                        <i class="fa fa-qrcode mr-1"></i> 生成二维码
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <h4 class="font-bold mb-2">用户排名</h4>
                        <div class="max-h-[300px] overflow-y-auto border border-gray-200 rounded-lg">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left">排名</th>
                                        <th class="px-3 py-2 text-left">用户名</th>
                                        <th class="px-3 py-2 text-left">用户ID</th>
                                        <th class="px-3 py-2 text-left">积分</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list">
                                    ${allUsers.length > 0 ? '' : '<tr><td colspan="4" class="px-3 py-4 text-center text-gray-500">暂无用户数据</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <button id="export-data" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded transition-colors">
                                导出数据
                            </button>
                            <button id="close-admin-data" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded transition-colors">
                                关闭
                            </button>
                        </div>
                    </div>
                `;
                
                // 填充用户列表
                if (allUsers.length > 0) {
                    const userList = document.getElementById('admin-user-list');
                    allUsers.forEach((user, index) => {
                        const row = document.createElement('tr');
                        row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                        row.innerHTML = `
                            <td class="px-3 py-2">${index + 1}</td>
                            <td class="px-3 py-2">${user.name}</td>
                            <td class="px-3 py-2">${user.id}</td>
                            <td class="px-3 py-2 font-bold text-blue-600">${user.score}</td>
                        `;
                        userList.appendChild(row);
                    });
                }
                
                // 绑定关闭按钮事件
                document.getElementById('close-admin-data').addEventListener('click', () => {
                    overlay.classList.add('hidden');
                });
                
                // 绑定导出数据按钮事件
                document.getElementById('export-data').addEventListener('click', () => {
                    // 准备导出数据
                    const exportData = {
                        totalUsers,
                        totalAttempts,
                        totalCorrect,
                        accuracy,
                        ranking: allUsers,
                        exportTime: new Date().toISOString()
                    };
                    
                    // 创建下载链接
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `诗词游戏数据_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert('数据导出成功！');
                });
                
                // 绑定生成同步密钥按钮事件
                const generateSyncKeyBtn = document.getElementById('generate-sync-key');
                if (generateSyncKeyBtn) {
                    generateSyncKeyBtn.addEventListener('click', () => {
                        // 生成随机同步密钥
                        const syncKey = 'sync_' + Math.random().toString(36).substr(2, 10);
                        document.getElementById('admin-sync-key').value = syncKey;
                        
                        // 生成用户访问链接
                        const currentUrl = window.location.href.split('?')[0];
                        const userAccessLink = currentUrl + '?syncKey=' + syncKey;
                        document.getElementById('user-access-link').value = userAccessLink;
                        
                        // 保存同步密钥密钥到localStorage
                        localStorage.setItem('literaryGameAdminSyncKey', syncKey);
                        
                        alert('同步密钥生成成功！');
                    });
                }
                
                // 绑定复制访问链接按钮事件
                const copyAccessLinkBtn = document.getElementById('copy-access-link');
                if (copyAccessLinkBtn) {
                    copyAccessLinkBtn.addEventListener('click', () => {
                        const userAccessLink = document.getElementById('user-access-link').value;
                        if (userAccessLink) {
                            const textarea = document.createElement('textarea');
                            textarea.value = userAccessLink;
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                            alert('链接访问链接已复制成功！');
                        } else {
                            alert('请先生成同步密钥！');
                        }
                    });
                }
                
                // 绑定生成二维码按钮事件
                const qrCodeBtn = document.getElementById('qr-code-btn');
                if (qrCodeBtn) {
                    qrCodeBtn.addEventListener('click', () => {
                        const userAccessLink = document.getElementById('user-access-link').value;
                        if (userAccessLink) {
                            // 使用picsum生成二维码图片（实际应用中应该使用专门的二维码生成API）
                            const qrCodeUrl = `https://picsum.photos/seed/${encodeURIComponent(userAccessLink)}/200/200`;
                            
                            // 显示二维码弹窗
                            const qrOverlay = document.getElementById('overlay');
                            const qrOverlayContent = document.getElementById('overlay-content');
                            
                            qrOverlayContent.innerHTML = `
                                <div class="text-center">
                                    <h3 class="text-xl font-bold mb-4">用户访问二维码</h3>
                                    <div class="bg-white p-2 rounded-lg shadow-md inline-block mb-4">
                                        <img src="${qrCodeUrl}" alt="用户访问二维码" class="w-48 h-48">
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">请使用微信扫描此二维码访问游戏</p>
                                    <button id="close-qr-code" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                                        关闭
                                    </button>
                                </div>
                            `;
                            
                            qrOverlay.classList.remove('hidden');
                            
                            // 绑定关闭按钮事件
                            document.getElementById('close-qr-code').addEventListener('click', () => {
                                qrOverlay.classList.add('hidden');
                            });
                        } else {
                            alert('请先生成同步密钥！');
                        }
                    });
                }
                
                // 如果已有同步密钥，自动生成用户访问链接
                const adminSyncKey = urlParams.get('syncKey') || localStorage.getItem('literaryGameAdminSyncKey');
                if (adminSyncKey) {
                    const currentUrl = window.location.href.split('?')[0];
                    const userAccessLink = currentUrl + '?syncKey=' + adminSyncKey;
                    document.getElementById('user-access-link').value = userAccessLink;
                }
            }
        };

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', () => {
            gameData.init();
            
            // 检查是否有邀请者ID
            const urlParams = new URLSearchParams(window.location.search);
            const inviterId = urlParams.get('inviter');
            
            if (inviterId) {
                console.log(`用户通过邀请者 ${inviterId} 的链接访问`);
                // 记录邀请访问（实际记录在recordInvitation函数中，当用户完成分享时）
            }
        });
    </script>
</body>
</html>
