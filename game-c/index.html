<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>诗词填空挑战 - 文学知识小游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 自定义切换按钮样式 */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        .toggle-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.2);
        }
        
        /* 动画效果 */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .bounce {
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* 填空样式 */
        .blank {
            display: inline-block;
            min-width: 30px;
            border-bottom: 2px solid #333;
            margin: 0 5px;
            padding: 0 5px;
            text-align: center;
        }
        
        .blank-filled {
            border-bottom: 2px solid #3B82F6;
            color: #3B82F6;
            font-weight: bold;
        }
        
        .blank-error {
            color: #EF4444;
            border-bottom: 2px solid #EF4444;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
    <!-- 遮罩层 -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center hidden fade-in">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div id="overlay-content"></div>
        </div>
    </div>

    <!-- 主容器 -->
    <div id="app" class="max-w-md mx-auto p-5 bg-white rounded-lg shadow-md shadow-md mt-5 min-h-screen">
        <!-- 页面头部 -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">诗词填空挑战</h1>
            <div class="flex items-center gap-3">
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center">
                    <i class="fa fa-star mr-1"></i>
                    <span id="score-display">0</span>
                </span>
                <button id="rules-btn" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">
                    <i class="fa fa-question-circle"></i>
                </button>
            </div>
        </header>

        <!-- 游戏状态 -->
        <div class="flex justify-between items-center mb-6">
            <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm flex items-center">
                <i class="fa fa-refresh mr-1"></i>
                <span>剩余次数: </span>
                <span id="attempts-display">3</span>
            </div>
            <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm flex items-center">
                <i class="fa fa-trophy mr-1"></i>
                <span id="rank-display">--</span>
            </div>
        </div>

        <!-- 关注提示 (首次访问显示) -->
        <div id="follow-prompt" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg fade-in">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fa fa-info-circle text-yellow-400 text-xl"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        欢迎来到诗词填空挑战，关注公众号即可开始游戏，每天3次挑战机会，分享可增加1次哦~
                    </p>
                    <div class="mt-3 flex justify-center">
                        <div class="bg-white p-2 rounded-lg shadow-md inline-block">
                            <img src="https://picsum.photos/150/150?random=1" alt="公众号二维码" class="w-32 h-32">
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <button id="confirm-follow" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            已关注，开始挑战
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 游戏区域 -->
        <div id="game-area" class="hidden fade-in">
            <!-- 诗词题目 -->
            <div class="bg-blue-50 p-5 rounded-lg mb-6 min-h-[120px] flex items-center justify-center">
                <div id="poem-container" class="text-center text-gray-800 text-lg leading-relaxed"></div>
            </div>

            <!-- 选项区域 -->
            <div id="options-container" class="grid grid-cols-2 gap-3 mb-6"></div>

            <!-- 反馈信息 -->
            <div id="feedback" class="text-center font-medium min-h-[24px] mb-6"></div>

            <!-- 操作按钮 -->
            <div class="flex gap-3">
                <button id="next-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors hidden">
                    下一题
                </button>
                <button id="share-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded transition-colors flex items-center justify-center">
                    <i class="fa fa-share-alt mr-2"></i>
                    分享增加次数
                </button>
            </div>
        </div>

        <!-- 排行榜区域 -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                <i class="fa fa-trophy text-yellow-500 mr-2"></i>
                诗词达人榜
            </h2>
            <div id="ranking-container" class="bg-gray-50 rounded-lg p-4 max-h-[300px] overflow-y-auto">
                <div id="ranking-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- 底部导航 -->
        <footer class="mt-8 py-4 border-t border-gray-200">
            <div class="flex justify-around">
                <button id="home-btn" class="flex flex-col items-center text-blue-500">
                    <i class="fa fa-home text-xl"></i>
                    <span class="text-xs mt-1">首页</span>
                </button>
                <button id="ranking-btn" class="flex flex-col items-center text-gray-500 hover:text-blue-500 transition-colors">
                    <i class="fa fa-list text-xl"></i>
                    <span class="text-xs mt-1">排行榜</span>
                </button>
                <button id="user-btn" class="flex flex-col items-center text-gray-500 hover:text-blue-500 transition-colors">
                    <i class="fa fa-user text-xl"></i>
                    <span class="text-xs mt-1">我的</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- 管理员按钮 (隐藏) -->
    <div class="fixed bottom-4 right-4 opacity-0 hover:opacity-100 transition-opacity duration-300">
        <button id="admin-btn" class="bg-red-500 text-white p-3 rounded-full shadow-lg hover:bg-red-600 transition-colors">
            <i class="fa fa-cog"></i>
        </button>
    </div>

    <!-- 微信JS-SDK -->
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    
    <script>
        // 工具函数
        const utils = {
            // 生成唯一ID
            generateId(prefix = 'user') {
                return `${prefix}_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
            },
            
            // 获取今天的日期字符串
            getToday() {
                return new Date().toDateString();
            },
            
            // 深拷贝对象
            deepClone(obj) {
                return JSON.parse(JSON.stringify(obj));
            },
            
            // 随机排序数组
            shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            },
            
            // 显示消息提示
            showMessage(text, type = 'info') {
                const feedbackEl = document.getElementById('feedback');
                feedbackEl.textContent = text;
                
                // 设置样式
                feedbackEl.className = 'text-center font-medium min-h-[24px] mb-6';
                switch(type) {
                    case 'success':
                        feedbackEl.classList.add('text-green-600');
                        feedbackEl.classList.add('bounce');
                        break;
                    case 'error':
                        feedbackEl.classList.add('text-red-600');
                        break;
                    default:
                        feedbackEl.classList.add('text-gray-600');
                }
                
                // 3秒后清除动画类
                setTimeout(() => {
                    feedbackEl.classList.remove('bounce');
                }, 3000);
            }
        };

        // 数据存储管理
        const storageManager = {
            prefix: 'literaryGame',
            
            // 设置数据
            set(key, value) {
                try {
                    const storageKey = `${this.prefix}_${key}`;
                    localStorage.setItem(storageKey, typeof value === 'object' 
                        ? JSON.stringify(value) 
                        : value.toString()
                    );
                    return true;
                } catch (error) {
                    console.error('存储失败:', error);
                    return false;
                }
            },
            
            // 获取数据
            get(key, defaultValue = null) {
                try {
                    const storageKey = `${this.prefix}_${key}`;
                    const value = localStorage.getItem(storageKey);
                    if (value === null) return defaultValue;
                    
                    // 尝试解析JSON
                    try {
                        return JSON.parse(value);
                    } catch {
                        return value;
                    }
                } catch (error) {
                    console.error('获取存储失败:', error);
                    return defaultValue;
                }
            },
            
            // 删除数据
            remove(key) {
                try {
                    const storageKey = `${this.prefix}_${key}`;
                    localStorage.removeItem(storageKey);
                    return true;
                } catch (error) {
                    console.error('删除存储失败:', error);
                    return false;
                }
            }
        };

        // 微信分享管理器
        const wechatShare = {
            config: {
                appId: 'wx1234567890abcdef', // 替换为实际的公众号appId
                timestamp: Math.floor(Date.now() / 1000),
                nonceStr: Math.random().toString(36).substr(2, 15),
                signature: '', // 实际使用时需要从后端获取
                
                shareConfig: {
                    title: '诗词填空挑战 - 来测试一下你的诗词储备吧！',
                    desc: '每天3次挑战机会，答对一题得10分，分享还能多一次机会哦！',
                    link: window.location.href,
                    imgUrl: 'https://picsum.photos/200/200?random=100',
                    
                    success: function() {
                        console.log('分享成功');
                        game.recordShareSuccess();
                    },
                    
                    cancel: function() {
                        console.log('分享取消');
                    }
                }
            },
            
            // 初始化微信分享
            init() {
                if (typeof WeixinJSBridge === 'undefined') {
                    console.log('不在微信环境中，无法使用微信分享功能');
                    return false;
                }
                
                wx.config({
                    debug: false,
                    appId: this.config.appId,
                    timestamp: this.config.timestamp,
                    nonceStr: this.config.nonceStr,
                    signature: this.config.signature,
                    jsApiList: [
                        'updateAppMessageShareData',
                        'updateTimelineShareData',
                        'onMenuShareAppMessage',
                        'onMenuShareTimeline'
                    ]
                });
                
                wx.ready(() => {
                    console.log('微信JS-SDK配置成功');
                    this.setupShareHandlers();
                });
                
                wx.error((res) => {
                    console.error('微信JS-SDK配置错误:', res);
                });
                
                return true;
            },
            
            // 设置分享处理器
            setupShareHandlers() {
                const config = this.config.shareConfig;
                
                // 分享给朋友
                wx.updateAppMessageShareData({
                    title: config.title,
                    desc: config.desc,
                    link: config.link,
                    imgUrl: config.imgUrl,
                    success: config.success,
                    cancel: config.cancel
                });
                
                // 分享到朋友圈
                wx.updateTimelineShareData({
                    title: config.title,
                    link: config.link,
                    imgUrl: config.imgUrl,
                    success: config.success,
                    cancel: config.cancel
                });
                
                // 兼容旧版本
                wx.onMenuShareAppMessage(config);
                wx.onMenuShareTimeline(config);
            },
            
            // 触发分享
            triggerShare() {
                if (typeof WeixinJSBridge === 'undefined') {
                    utils.showMessage('请在微信中打开以使用分享功能', 'error');
                    return false;
                }
                
                try {
                    // 隐藏所有非基础按钮
                    WeixinJSBridge.call('hideAllNonBaseMenuItem');
                    // 显示分享按钮
                    WeixinJSBridge.call('showMenuItems', {
                        menuList: [
                            'menuItem:share:appMessage', // 分享给朋友
                            'menuItem:share:timeline'    // 分享到朋友圈
                        ]
                    });
                    return true;
                } catch (error) {
                    console.error('触发分享失败:', error);
                    return false;
                }
            }
        };

        // 诗词数据库
        const poemDatabase = [
            {
                text: "床前明月光，疑是地上___。举头望明月，低头思___。",
                blanks: ["霜", "故乡"],
                options: ["霜", "雪", "故乡", "家乡"],
                author: "李白",
                title: "静夜思"
            },
            {
                text: "锄禾日当午，汗滴禾下___。谁知盘中餐，粒粒皆___。",
                blanks: ["土", "辛苦"],
                options: ["土", "地", "辛苦", "劳累"],
                author: "李绅",
                title: "悯农"
            },
            {
                text: "春眠不觉晓，处处闻___。夜来风雨声，花落知___。",
                blanks: ["啼鸟", "多少"],
                options: ["啼鸟", "鸟鸣", "多少", "几何"],
                author: "孟浩然",
                title: "春晓"
            },
            {
                text: "白日依山尽，黄河入海___。欲穷千里目，更上一层___。",
                blanks: ["流", "楼"],
                options: ["流", "游", "楼", "台"],
                author: "王之涣",
                title: "登鹳雀楼"
            },
            {
                text: "千山鸟飞绝，万径人踪___。孤舟蓑笠翁，独钓寒江___。",
                blanks: ["灭", "雪"],
                options: ["灭", "绝", "雪", "霜"],
                author: "柳宗元",
                title: "江雪"
            }
        ];

        // 游戏主逻辑
        const game = {
            // 游戏配置
            config: {
                initialAttempts: 3,
                pointsPerCorrect: 10,
                maxDailyShares: 3,
                syncInterval: 300000 // 5分钟自动同步一次
            },
            
            // 游戏状态
            state: {
                userId: null,
                userName: null,
                score: 0,
                attempts: 0,
                shareCount: 0,
                currentPoem: null,
                userAnswers: [],
                isGameStarted: false,
                lastPlayDate: null,
                lastShareDate: null,
                lastSyncTime: null,
                syncToken: null,
                enableAutoSync: true
            },
            
            // DOM元素
            elements: {
                followPrompt: null,
                gameArea: null,
                poemContainer: null,
                optionsContainer: null,
                feedback: null,
                nextBtn: null,
                shareBtn: null,
                scoreDisplay: null,
                attemptsDisplay: null,
                rankDisplay: null,
                rankingList: null,
                rulesBtn: null,
                confirmFollow: null,
                overlay: null,
                overlayContent: null
            },
            
            // 初始化游戏
            init() {
                // 获取DOM元素
                this.initElements();
                
                // 设置事件监听
                this.setupEventListeners();
                
                // 初始化用户数据
                this.initUserData();
                
                // 初始化微信分享
                wechatShare.init();
                
                // 检查是否首次访问
                const hasVisited = storageManager.get('hasVisited', false);
                if (!hasVisited) {
                    this.elements.followPrompt.classList.remove('hidden');
                    storageManager.set('hasVisited', true);
                } else {
                    this.startGame();
                }
            },
            
            // 获取DOM元素引用
            initElements() {
                this.elements = {
                    followPrompt: document.getElementById('follow-prompt'),
                    gameArea: document.getElementById('game-area'),
                    poemContainer: document.getElementById('poem-container'),
                    optionsContainer: document.getElementById('options-container'),
                    feedback: document.getElementById('feedback'),
                    nextBtn: document.getElementById('next-btn'),
                    shareBtn: document.getElementById('share-btn'),
                    scoreDisplay: document.getElementById('score-display'),
                    attemptsDisplay: document.getElementById('attempts-display'),
                    rankDisplay: document.getElementById('rank-display'),
                    rankingList: document.getElementById('ranking-list'),
                    rulesBtn: document.getElementById('rules-btn'),
                    confirmFollow: document.getElementById('confirm-follow'),
                    overlay: document.getElementById('overlay'),
                    overlayContent: document.getElementById('overlay-content'),
                    adminBtn: document.getElementById('admin-btn'),
                    homeBtn: document.getElementById('home-btn'),
                    rankingBtn: document.getElementById('ranking-btn'),
                    userBtn: document.getElementById('user-btn')
                };
            },
            
            // 设置事件监听器
            setupEventListeners() {
                // 确认关注按钮
                this.elements.confirmFollow.addEventListener('click', () => {
                    this.elements.followPrompt.classList.add('hidden');
                    this.startGame();
                });
                
                // 下一题按钮
                this.elements.nextBtn.addEventListener('click', () => {
                    this.loadNextPoem();
                });
                
                // 分享按钮
                this.elements.shareBtn.addEventListener('click', () => {
                    this.handleShare();
                });
                
                // 规则按钮
                this.elements.rulesBtn.addEventListener('click', () => {
                    this.showRules();
                });
                
                // 管理员按钮
                this.elements.adminBtn.addEventListener('click', () => {
                    this.showAdminPanel();
                });
                
                // 导航按钮
                this.elements.rankingBtn.addEventListener('click', () => {
                    this.scrollToRanking();
                });
            },
            
            // 初始化用户数据
            initUserData() {
                // 获取或生成用户ID
                this.state.userId = storageManager.get('userId');
                if (!this.state.userId) {
                    this.state.userId = utils.generateId();
                    storageManager.set('userId', this.state.userId);
                }
                
                // 获取用户名
                this.state.userName = storageManager.get('userName') || `诗词爱好者${Math.floor(Math.random() * 1000)}`;
                
                // 加载游戏数据
                this.loadGameData();
                
                // 更新UI显示
                this.updateScoreDisplay();
                this.updateAttemptsDisplay();
            },
            
            // 加载游戏数据
            loadGameData() {
                const today = utils.getToday();
                
                // 加载分数
                this.state.score = parseInt(storageManager.get(`score_${this.state.userId}`, 0));
                
                // 处理每日重置
                this.state.lastPlayDate = storageManager.get(`lastPlayDate_${this.state.userId}`);
                if (this.state.lastPlayDate !== today) {
                    this.state.attempts = this.config.initialAttempts;
                    storageManager.set(`lastPlayDate_${this.state.userId}`, today);
                } else {
                    this.state.attempts = parseInt(storageManager.get(`attempts_${this.state.userId}`, this.config.initialAttempts));
                }
                
                // 处理分享次数
                this.state.lastShareDate = storageManager.get(`lastShareDate_${this.state.userId}`);
                if (this.state.lastShareDate !== today) {
                    this.state.shareCount = 0;
                    storageManager.set(`lastShareDate_${this.state.userId}`, today);
                } else {
                    this.state.shareCount = parseInt(storageManager.get(`shareCount_${this.state.userId}`, 0));
                }
                
                // 加载同步设置
                this.state.enableAutoSync = storageManager.get('enableAutoSync', true);
                this.state.syncToken = storageManager.get('syncToken');
                this.state.lastSyncTime = storageManager.get('lastSyncTime');
            },
            
            // 开始游戏
            startGame() {
                this.state.isGameStarted = true;
                this.elements.gameArea.classList.remove('hidden');
                this.loadNextPoem();
                this.updateRanking();
                
                // 如果启用自动同步，设置定时同步
                if (this.state.enableAutoSync) {
                    this.setupAutoSync();
                }
            },
            
            // 加载下一首诗词
            loadNextPoem() {
                // 检查是否还有尝试次数
                if (this.state.attempts <= 0) {
                    utils.showMessage('没有剩余挑战次数了，分享可以增加次数哦', 'error');
                    return;
                }
                
                // 重置UI状态
                this.elements.feedback.textContent = '';
                this.elements.nextBtn.classList.add('hidden');
                this.state.userAnswers = [];
                
                // 随机选择一首诗词
                const randomIndex = Math.floor(Math.random() * poemDatabase.length);
                this.state.currentPoem = utils.deepClone(poemDatabase[randomIndex]);
                
                // 显示诗词
                this.displayPoem();
                
                // 显示选项
                this.displayOptions();
            },
            
            // 显示诗词 - 优化版本：将横线替换为可填充的元素
            displayPoem() {
                // 将文本中的"___"替换为带有类名的span元素
                let formattedText = this.state.currentPoem.text.replace(/_+/g, (match, index) => {
                    // 计算这是第几个空白处
                    const blankIndex = this.state.currentPoem.text.substring(0, index).split(/_+/).length - 1;
                    return `<span class="blank" data-index="${blankIndex}"></span>`;
                });
                
                this.elements.poemContainer.innerHTML = formattedText;
            },
            
            // 显示选项
            displayOptions() {
                this.elements.optionsContainer.innerHTML = '';
                
                // 随机排序选项
                const shuffledOptions = utils.shuffleArray(this.state.currentPoem.options);
                
                // 创建选项按钮
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'bg-gray-100 hover:bg-gray-200 text-gray-800 py-3 px-4 rounded-lg transition-colors';
                    button.textContent = option;
                    button.addEventListener('click', () => this.handleOptionSelect(option, button));
                    this.elements.optionsContainer.appendChild(button);
                });
            },
            
            // 处理选项选择 - 优化版本：将选择的答案显示在对应的空白处
            handleOptionSelect(option, button) {
                // 检查是否已经回答完毕
                if (this.state.userAnswers.length >= this.state.currentPoem.blanks.length) {
                    return;
                }
                
                // 记录答案
                const answerIndex = this.state.userAnswers.length;
                this.state.userAnswers.push(option);
                
                // 显示答案在对应的空白处
                const blankElements = this.elements.poemContainer.querySelectorAll('.blank');
                if (blankElements[answerIndex]) {
                    blankElements[answerIndex].textContent = option;
                    blankElements[answerIndex].classList.add('blank-filled');
                }
                
                // 样式处理
                button.classList.add('bg-blue-100');
                button.disabled = true;
                
                // 检查是否回答完所有空缺
                if (this.state.userAnswers.length === this.state.currentPoem.blanks.length) {
                    this.checkAnswer();
                }
            },
            
            // 检查答案
            checkAnswer() {
                // 减少尝试次数
                this.state.attempts--;
                this.updateAttemptsDisplay();
                storageManager.set(`attempts_${this.state.userId}`, this.state.attempts);
                
                // 检查是否全部正确
                const isAllCorrect = this.state.userAnswers.every((answer, index) => {
                    return answer === this.state.currentPoem.blanks[index];
                });
                
                // 显示结果
                if (isAllCorrect) {
                    // 加分
                    this.state.score += this.config.pointsPerCorrect;
                    this.updateScoreDisplay();
                    storageManager.set(`score_${this.state.userId}`, this.state.score);
                    
                    utils.showMessage(`恭喜！回答正确，加${this.config.pointsPerCorrect}分！`, 'success');
                    
                    // 更新排行榜
                    this.updateRanking();
                } else {
                    // 显示正确答案
                    const correctAnswers = this.state.currentPoem.blanks.join('、');
                    utils.showMessage(`回答错误，正确答案是：${correctAnswers}`, 'error');
                    
                    // 高亮显示错误的答案
                    const blankElements = this.elements.poemContainer.querySelectorAll('.blank');
                    this.state.userAnswers.forEach((answer, index) => {
                        if (answer !== this.state.currentPoem.blanks[index] && blankElements[index]) {
                            blankElements[index].classList.add('blank-error');
                        }
                    });
                }
                
                // 显示下一题按钮
                this.elements.nextBtn.classList.remove('hidden');
            },
            
            // 处理分享
            handleShare() {
                // 检查是否还能通过分享获得次数
                if (this.state.shareCount >= this.config.maxDailyShares) {
                    utils.showMessage('今天的分享次数已用完，明天再来吧', 'error');
                    return;
                }
                
                // 触发微信分享
                wechatShare.triggerShare();
            },
            
            // 记录分享成功
            recordShareSuccess() {
                if (this.state.shareCount < this.config.maxDailyShares) {
                    this.state.shareCount++;
                    this.state.attempts++;
                    
                    // 保存数据
                    storageManager.set(`shareCount_${this.state.userId}`, this.state.shareCount);
                    storageManager.set(`attempts_${this.state.userId}`, this.state.attempts);
                    
                    // 更新UI
                    this.updateAttemptsDisplay();
                    utils.showMessage('分享成功，增加1次挑战机会！', 'success');
                }
            },
            
            // 更新排行榜
            updateRanking() {
                // 保存当前用户分数到排行榜
                const ranking = storageManager.get('ranking', []);
                
                // 检查用户是否已在排行榜中
                const userIndex = ranking.findIndex(item => item.userId === this.state.userId);
                if (userIndex >= 0) {
                    ranking[userIndex].score = this.state.score;
                } else {
                    ranking.push({
                        userId: this.state.userId,
                        userName: this.state.userName,
                        score: this.state.score
                    });
                }
                
                // 按分数排序并保存
                ranking.sort((a, b) => b.score - a.score);
                storageManager.set('ranking', ranking);
                
                // 显示排行榜
                this.displayRanking(ranking);
                
                // 更新用户排名
                this.updateUserRank(ranking);
            },
            
            // 显示排行榜
            displayRanking(ranking) {
                this.elements.rankingList.innerHTML = '';
                
                // 只显示前10名
                const displayRanking = ranking.slice(0, 10);
                
                displayRanking.forEach((item, index) => {
                    const rankItem = document.createElement('div');
                    rankItem.className = 'flex justify-between items-center p-2 bg-white rounded shadow-sm';
                    
                    // 排名样式
                    let rankClass = 'bg-gray-200 text-gray-800';
                    if (index === 0) rankClass = 'bg-yellow-100 text-yellow-800';
                    else if (index === 1) rankClass = 'bg-gray-100 text-gray-800';
                    else if (index === 2) rankClass = 'bg-amber-100 text-amber-800';
                    
                    rankItem.innerHTML = `
                        <div class="flex items-center">
                            <span class="${rankClass} w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-2">
                                ${index + 1}
                            </span>
                            <span class="font-medium">${item.userName}</span>
                        </div>
                        <span class="text-blue-600 font-bold">${item.score}分</span>
                    `;
                    
                    this.elements.rankingList.appendChild(rankItem);
                });
            },
            
            // 更新用户排名
            updateUserRank(ranking) {
                const userIndex = ranking.findIndex(item => item.userId === this.state.userId);
                if (userIndex >= 0) {
                    this.elements.rankDisplay.textContent = userIndex + 1;
                } else {
                    this.elements.rankDisplay.textContent = '--';
                }
            },
            
            // 显示游戏规则
            showRules() {
                this.elements.overlayContent.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">游戏规则</h3>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>每天有3次挑战机会</li>
                        <li>每答对一题得10分</li>
                        <li>每天最多可通过分享增加3次挑战机会</li>
                        <li>系统会自动记录您的分数和排名</li>
                    </ul>
                    <button id="close-rules" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors w-full">
                        我知道了
                    </button>
                `;
                
                this.elements.overlay.classList.remove('hidden');
                
                // 添加关闭按钮事件
                document.getElementById('close-rules').addEventListener('click', () => {
                    this.elements.overlay.classList.add('hidden');
                });
            },
            
            // 显示管理员面板
            showAdminPanel() {
                this.elements.overlayContent.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">管理员面板</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="auto-sync-toggle" class="mr-2" ${this.state.enableAutoSync ? 'checked' : ''}>
                                <span>启用自动同步</span>
                            </label>
                        </div>
                        <button id="reset-game" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded transition-colors w-full">
                            重置游戏数据
                        </button>
                        <button id="close-admin" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded transition-colors w-full">
                            关闭
                        </button>
                    </div>
                `;
                
                this.elements.overlay.classList.remove('hidden');
                
                // 自动同步开关事件
                document.getElementById('auto-sync-toggle').addEventListener('change', (e) => {
                    this.state.enableAutoSync = e.target.checked;
                    storageManager.set('enableAutoSync', this.state.enableAutoSync);
                    this.setupAutoSync();
                });
                
                // 重置游戏数据事件
                document.getElementById('reset-game').addEventListener('click', () => {
                    if (confirm('确定要重置所有游戏数据吗？')) {
                        this.resetGameData();
                        this.elements.overlay.classList.add('hidden');
                    }
                });
                
                // 关闭按钮事件
                document.getElementById('close-admin').addEventListener('click', () => {
                    this.elements.overlay.classList.add('hidden');
                });
            },
            
            // 重置游戏数据
            resetGameData() {
                // 清除用户相关数据
                storageManager.remove(`score_${this.state.userId}`);
                storageManager.remove(`attempts_${this.state.userId}`);
                storageManager.remove(`lastPlayDate_${this.state.userId}`);
                storageManager.remove(`shareCount_${this.state.userId}`);
                storageManager.remove(`lastShareDate_${this.state.userId}`);
                
                // 重新加载数据
                this.loadGameData();
                
                // 更新UI
                this.updateScoreDisplay();
                this.updateAttemptsDisplay();
                this.loadNextPoem();
                this.updateRanking();
                
                utils.showMessage('游戏数据已重置', 'info');
            },
            
            // 设置自动同步
            setupAutoSync() {
                // 清除已有的定时器
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                }
                
                // 如果启用自动同步，设置新的定时器
                if (this.state.enableAutoSync) {
                    this.syncTimer = setInterval(() => {
                        this.syncData();
                    }, this.config.syncInterval);
                }
            },
            
            // 同步数据
            syncData() {
                // 实际项目中这里会与后端进行数据同步
                console.log('同步数据...');
                this.state.lastSyncTime = new Date().toISOString();
                storageManager.set('lastSyncTime', this.state.lastSyncTime);
            },
            
            // 滚动到排行榜
            scrollToRanking() {
                document.getElementById('ranking-container').scrollIntoView({
                    behavior: 'smooth'
                });
            },
            
            // 更新分数显示
            updateScoreDisplay() {
                this.elements.scoreDisplay.textContent = this.state.score;
            },
            
            // 更新尝试次数显示
            updateAttemptsDisplay() {
                this.elements.attemptsDisplay.textContent = this.state.attempts;
            }
        };

        // 页面加载完成后初始化游戏
        document.addEventListener('DOMContentLoaded', () => {
            game.init();
        });
    </script>
</body>
</html>
